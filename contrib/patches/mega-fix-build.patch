From f9dfae6f86d3046c6f0546c3f454e9d5ac7f8cc4 Mon Sep 17 00:00:00 2001
From: =?UTF-8?q?Pawe=C5=82=20Wegner?= <pawel.wegner95@gmail.com>
Date: Fri, 18 Dec 2020 00:58:28 +0100
Subject: [PATCH] mega: fix build.

---
 contrib/cmake/CMakeLists.txt | 23 ++++++-----------------
 include/mega.h               |  1 -
 include/mega/posix/megafs.h  |  1 +
 include/mega/posix/megasys.h |  1 -
 src/win32/net.cpp            |  1 +
 5 files changed, 8 insertions(+), 19 deletions(-)

diff --git a/contrib/cmake/CMakeLists.txt b/contrib/cmake/CMakeLists.txt
index 4fb13976b..5e10bb059 100644
--- a/contrib/cmake/CMakeLists.txt
+++ b/contrib/cmake/CMakeLists.txt
@@ -216,10 +216,6 @@ else(NOT CMAKE_BUILD_TYPE)
     message("CMAKE_BUILD_TYPE is ${CMAKE_BUILD_TYPE}")
 endif(NOT CMAKE_BUILD_TYPE)
 
-#windows projects usually need _DEBUG and/or DEBUG set rather than NDEBUG not set
-set(CMAKE_C_FLAGS_DEBUG "${CMAKE_C_FLAGS_DEBUG} -D_DEBUG -DDEBUG")
-set(CMAKE_CXX_FLAGS_DEBUG "${CMAKE_CXX_FLAGS_DEBUG} -D_DEBUG -DDEBUG")
-
 if (WIN32)
     # node deletion in debug under VC++ is pretty slow without this.  However libraries we depend on need to be built with the same setting or linking fails 
     # (hence the build3rdParty script using the xNN-windows-static-uncheckediterators triplets)
@@ -481,8 +477,7 @@ if(WIN32)
     SET(Mega_PlatformSpecificFiles ${MegaDir}/src/win32/console.cpp
     ${MegaDir}/src/win32/consolewaiter.cpp 
     ${MegaDir}/src/win32/fs.cpp 
-    $<IF:${USE_CURL},${MegaDir}/src/posix/net.cpp,${MegaDir}/src/win32/net.cpp>
-    ${MegaDir}/src/win32/waiter.cpp 
+    ${MegaDir}/src/win32/waiter.cpp
     $<${USE_CPPTHREAD}:${MegaDir}/src/thread/cppthread.cpp>
     )
 
@@ -497,18 +492,16 @@ ELSE(WIN32)
         set(GLOB_H_FOUND 0)   #some versions on some platforms leave it undefined if not found
     endif()
 
-    SET(Mega_PlatformSpecificFiles $<$<NOT:${GLOB_H_FOUND}>:${MegaDir}/src/mega_glob.c> ${MegaDir}/src/posix/console.cpp ${MegaDir}/src/posix/consolewaiter.cpp ${MegaDir}/src/posix/fs.cpp ${MegaDir}/src/posix/net.cpp ${MegaDir}/src/posix/waiter.cpp ${MegaDir}/src/thread/posixthread.cpp $<${USE_CPPTHREAD}:${MegaDir}/src/thread/cppthread.cpp> )
+    SET(Mega_PlatformSpecificFiles $<$<NOT:${GLOB_H_FOUND}>:${MegaDir}/src/mega_glob.c> ${MegaDir}/src/posix/console.cpp ${MegaDir}/src/posix/consolewaiter.cpp ${MegaDir}/src/posix/fs.cpp ${MegaDir}/src/posix/waiter.cpp ${MegaDir}/src/thread/posixthread.cpp $<${USE_CPPTHREAD}:${MegaDir}/src/thread/cppthread.cpp> )
     IF(APPLE)
         SET(Mega_PlatformSpecificFiles ${Mega_PlatformSpecificFiles} ${MegaDir}/src/osx/osxutils.mm )
     ENDIF()
 
     SET(Mega_PlatformSpecificIncludes ${MegaDir}/include/mega/posix)
 
-    SET(Mega_PlatformSpecificLibs ${Mega_PlatformSpecificLibs} pthread z dl termcap)
+    SET(Mega_PlatformSpecificLibs ${Mega_PlatformSpecificLibs} dl)
     IF(APPLE)
         SET(Mega_PlatformSpecificLibs ${Mega_PlatformSpecificLibs} "-framework Cocoa -framework SystemConfiguration -framework Security")
-    ELSE()
-        SET(Mega_PlatformSpecificLibs ${Mega_PlatformSpecificLibs} crypto rt stdc++fs)
     ENDIF()
 
     IF(USE_WEBRTC)
@@ -517,7 +510,7 @@ ELSE(WIN32)
 
 ENDIF(WIN32)
 
-configure_file ("${MegaDir}/contrib/cmake/config.h.in" "${MegaDir}/include/mega/config.h" )
+configure_file ("${MegaDir}/contrib/cmake/config.h.in" "${CMAKE_BINARY_DIR}/include/mega/config.h" )
 add_definitions( -DHAVE_CONFIG_H) #otherwise, it won't be included in Windows build!
 
 SET(Mega_CryptoFiles ${MegaDir}/src/crypto/cryptopp.cpp ${MegaDir}/src/crypto/sodium.cpp)
@@ -525,8 +518,6 @@ SET(Mega_DbFiles ${MegaDir}/src/db/sqlite.cpp ${MegaDir}/src/db/sqlite.cpp )
 SET(Mega_GfxFiles ${MegaDir}/src/gfx/external.cpp ${MegaDir}/src/gfx/freeimage.cpp ) 
 
 add_library(Mega STATIC
-            ${MegaDir}/include/megaapi.h
-            ${MegaDir}/include/megaapi_impl.h
             ${MegaDir}/include/mega/osx/osxutils.h
             ${MegaDir}/include/mega/transferslot.h
             ${MegaDir}/include/mega/thread/qtthread.h
@@ -535,7 +526,7 @@ add_library(Mega STATIC
             ${MegaDir}/include/mega/thread/posixthread.h
             ${MegaDir}/include/mega/thread/libuvthread.h
             ${MegaDir}/include/mega/command.h
-            ${MegaDir}/include/mega/config.h
+            ${CMAKE_BINARY_DIR}/include/mega/config.h
             ${MegaDir}/include/mega/thread.h
             ${MegaDir}/include/mega/json.h
             ${MegaDir}/include/mega/base64.h
@@ -635,9 +626,7 @@ add_library(Mega STATIC
             ${MegaDir}/src/mega_http_parser.cpp 
             ${MegaDir}/src/mega_utf8proc.cpp 
             ${MegaDir}/src/mega_zxcvbn.cpp 
-            ${MegaDir}/src/megaapi.cpp 
-            ${MegaDir}/src/megaapi_impl.cpp 
-            ${MegaDir}/src/megaclient.cpp 
+            ${MegaDir}/src/megaclient.cpp
             ${MegaDir}/src/node.cpp 
             ${MegaDir}/src/pendingcontactrequest.cpp 
             ${MegaDir}/src/proxy.cpp 
diff --git a/include/mega.h b/include/mega.h
index 31ab29211..4b6763b66 100644
--- a/include/mega.h
+++ b/include/mega.h
@@ -73,7 +73,6 @@
 #include "mega/thread/cppthread.h"
 
 #include "megawaiter.h"
-#include "meganet.h"
 #include "megafs.h"
 #include "megaconsole.h"
 #include "megaconsolewaiter.h"
diff --git a/include/mega/posix/megafs.h b/include/mega/posix/megafs.h
index f212e27d0..b0f02011b 100644
--- a/include/mega/posix/megafs.h
+++ b/include/mega/posix/megafs.h
@@ -32,6 +32,7 @@
 #include <sys/mount.h>
 #else
 #include <sys/vfs.h>
+#include <dirent.h>
 #endif
 
 #ifdef HAVE_AIO_RT
diff --git a/include/mega/posix/megasys.h b/include/mega/posix/megasys.h
index de50ffc2e..c0a78d025 100644
--- a/include/mega/posix/megasys.h
+++ b/include/mega/posix/megasys.h
@@ -113,7 +113,6 @@
 
 #include <sys/select.h>
 
-#include <curl/curl.h>
 #include <stdexcept>
 
 #ifndef FD_COPY
diff --git a/src/win32/net.cpp b/src/win32/net.cpp
index 9014dc1e8..4c71df7ee 100644
--- a/src/win32/net.cpp
+++ b/src/win32/net.cpp
@@ -24,6 +24,7 @@
 
 #include "meganet.h"
 #include <winhttp.h>
+#include <wincrypt.h>
 
 namespace mega {
 
-- 
2.25.1

